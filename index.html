<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Afterski or Die</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  </head>
  <body>
    <script>
      var config = {
        type: Phaser.AUTO,
        width: 360,
        height: 640,
        physics: {
          default: "arcade",
          arcade: { gravity: { y: 0 }, debug: false },
        },
        scene: { preload: preload, create: create, update: update },
        scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
      };
      var game = new Phaser.Game(config);
      var player, cursors, collectibles, finishLine, trees, drunkenText;
      var drunkenness = 0;
      var finishReached = false;
      var pointerActive = false;
      function preload() {
        this.load.image("player", "/img/skier.png");
        this.load.image(
          "collectible",
          "https://labs.phaser.io/assets/sprites/star.png"
        );
        this.load.image("finish", "/img/afterski.png");
        this.load.image(
          "tree",
          "https://labs.phaser.io/assets/sprites/tree.png"
        );
        this.load.image("afterski", "/img/afterski.png");
      }
      function create() {
        this.cameras.main.setBackgroundColor("#ffffff");
        player = this.physics.add.sprite(180, 50, "player");
        player.setScale(0.1);
        player.setCollideWorldBounds(true);
        player.body.setSize(
          player.displayWidth * 0.8,
          player.displayHeight * 0.8
        );
        cursors = this.input.keyboard.createCursorKeys();
        collectibles = this.physics.add.group();
        for (var i = 0; i < 20; i++) {
          var x = Phaser.Math.Between(30, 330);
          var y = Phaser.Math.Between(100, 5000);
          collectibles.create(x, y, "collectible");
        }
        trees = this.physics.add.staticGroup();
        for (var j = 0; j < 30; j++) {
          var lane = Phaser.Math.Between(0, 2);
          var x;
          if (lane === 0) {
            x = Phaser.Math.Between(20, 120);
          } else if (lane === 1) {
            x = Phaser.Math.Between(130, 230);
          } else {
            x = Phaser.Math.Between(240, 340);
          }
          var y = Phaser.Math.Between(100, 5000);
          trees.create(x, y, "tree");
        }
        finishLine = this.physics.add
          .staticSprite(180, 5200, "finish")
          .setScale(0.5);
        drunkenText = this.add
          .text(10, 10, "Drunkenness: 0", { font: "20px Arial", fill: "#000" })
          .setScrollFactor(0);
        this.physics.add.overlap(player, collectibles, collectItem, null, this);
        this.physics.add.overlap(player, finishLine, reachFinish, null, this);
        this.physics.add.collider(player, trees);
        this.cameras.main.setBounds(0, 0, 360, 5400);
        this.physics.world.setBounds(0, 0, 360, 5400);
        this.cameras.main.startFollow(player, true, 0.05, 0.05);
        this.input.on(
          "pointerdown",
          function () {
            pointerActive = true;
          },
          this
        );
        this.input.on(
          "pointerup",
          function () {
            pointerActive = false;
          },
          this
        );
      }
      function update() {
        if (finishReached) return;
        var speed = 200;
        var controlFactor = Math.max(1 - drunkenness / 100, 0.3);
        player.setVelocityY(speed);
        var moveLeft = cursors.left.isDown;
        var moveRight = cursors.right.isDown;
        if (!moveLeft && !moveRight && pointerActive) {
          if (this.input.activePointer.x < config.width / 2) moveLeft = true;
          else moveRight = true;
        }
        if (moveLeft) player.setVelocityX(-speed * controlFactor);
        else if (moveRight) player.setVelocityX(speed * controlFactor);
        else player.setVelocityX(0);
        if (drunkenness > 0) {
          player.x += Phaser.Math.Between(-drunkenness / 50, drunkenness / 50);
        }
        drunkenText.setText("Promille: " + drunkenness / 100);
      }
      function collectItem(player, item) {
        item.disableBody(true, true);
        drunkenness += 10;
      }
      function reachFinish(player, finish) {
        if (finishReached) return;
        finishReached = true;
        player.setVelocity(0);
        if (drunkenness >= 50) {
          var msg = this.add
            .text(config.width / 2, config.height / 2, "Afterski!", {
              font: "24px Arial",
              fill: "#f00",
            })
            .setScrollFactor(0);
          msg.setOrigin(0.5);
        } else {
          var msg = this.add
            .text(
              config.width / 2,
              config.height / 2,
              "Not drunk enough for afterski!",
              { font: "24px Arial", fill: "#f00" }
            )
            .setScrollFactor(0);
          msg.setOrigin(0.5);
        }
      }
    </script>
  </body>
</html>
