<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Drunken Ski Game</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  </head>
  <body>
    <script>
      var config = {
        type: Phaser.AUTO,
        width: 360,
        height: 640,
        physics: {
          default: "arcade",
          arcade: { gravity: { y: 0 }, debug: false },
        },
        scene: { preload: preload, create: create, update: update },
        scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
      };

      var game = new Phaser.Game(config);
      var player, cursors, collectibles, finishLine, trees, drunkenText;
      var drunkenness = 0;
      var finishReached = false;
      var pointerActive = false;

      function preload() {
        this.load.image("player", "/img/skier.png");
        this.load.image(
          "collectible",
          "https://labs.phaser.io/assets/sprites/star.png"
        );
        this.load.image(
          "finish",
          "https://labs.phaser.io/assets/sprites/flag.png"
        );
        this.load.image(
          "tree",
          "https://labs.phaser.io/assets/sprites/tree.png"
        );
      }

      function create() {
        this.cameras.main.setBackgroundColor("#ffffff");
        player = this.physics.add.sprite(180, 50, "player");
        player.setScale(0.1);
        player.setCollideWorldBounds(true);
        cursors = this.input.keyboard.createCursorKeys();
        collectibles = this.physics.add.group();
        for (var i = 0; i < 20; i++) {
          var x = Phaser.Math.Between(30, 330);
          var y = Phaser.Math.Between(100, 5000);
          collectibles.create(x, y, "collectible");
        }
        trees = this.physics.add.staticGroup();
        for (var j = 0; j < 30; j++) {
          var x = Phaser.Math.Between(20, 340);
          var y = Phaser.Math.Between(100, 5000);
          trees.create(x, y, "tree");
        }
        finishLine = this.physics.add
          .staticSprite(180, 5200, "finish")
          .setScale(1.5);
        var finishText = this.add.text(
          finishLine.x - 40,
          finishLine.y - 60,
          "Ski Under",
          { font: "16px Arial", fill: "#000" }
        );
        finishText.setScrollFactor(0);
        drunkenText = this.add
          .text(10, 10, "Drunkenness: 0", { font: "20px Arial", fill: "#000" })
          .setScrollFactor(0);
        this.physics.add.overlap(player, collectibles, collectItem, null, this);
        this.physics.add.overlap(player, finishLine, reachFinish, null, this);
        this.physics.add.collider(player, trees);
        this.cameras.main.setBounds(0, 0, 360, 5400);
        this.physics.world.setBounds(0, 0, 360, 5400);
        this.cameras.main.startFollow(player, true, 0.05, 0.05);
        this.input.on(
          "pointerdown",
          function () {
            pointerActive = true;
          },
          this
        );
        this.input.on(
          "pointerup",
          function () {
            pointerActive = false;
          },
          this
        );
      }

      function update() {
        if (finishReached) return;
        var speed = 200;
        var controlFactor = Math.max(1 - drunkenness / 100, 0.3);
        player.setVelocityY(speed);
        var moveLeft = cursors.left.isDown;
        var moveRight = cursors.right.isDown;
        if (!moveLeft && !moveRight && pointerActive) {
          if (this.input.activePointer.x < config.width / 2) moveLeft = true;
          else moveRight = true;
        }
        if (moveLeft) player.setVelocityX(-speed * controlFactor);
        else if (moveRight) player.setVelocityX(speed * controlFactor);
        else player.setVelocityX(0);
        if (drunkenness > 0) {
          player.x += Phaser.Math.Between(-drunkenness / 50, drunkenness / 50);
        }
        drunkenText.setText("Drunkenness: " + drunkenness);
      }

      function collectItem(player, item) {
        item.disableBody(true, true);
        drunkenness += 10;
      }

      function reachFinish(player, finish) {
        finishReached = true;
        var message =
          drunkenness >= 50
            ? "After ski time!"
            : "Not drunk enough for afterski!";
        var finishMessage = this.add.text(player.x - 80, player.y, message, {
          font: "24px Arial",
          fill: "#f00",
        });
        finishMessage.setScrollFactor(0);
        player.setVelocity(0);
      }
    </script>
  </body>
</html>
